import pandas as pd
import numpy as np
from sklearn.naive_bayes import MultinomialNB
from sklearn.model_selection import GridSearchCV
from sklearn.preprocessing import MinMaxScaler, LabelEncoder
import os
import sys

# --- 1. Define Paths ---
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
PARENT_DIR = os.path.join(SCRIPT_DIR, '..')

PREPROCESSING_DIR = os.path.join(PARENT_DIR, 'preprocessing')
DATA_DIR = os.path.join(PARENT_DIR, 'data')
OUTPUT_DIR = os.path.join(PARENT_DIR, 'output')
os.makedirs(OUTPUT_DIR, exist_ok=True)

# Load files generated by preprocessing_2.py
TRAIN_PROCESSED_FILE = os.path.join(PREPROCESSING_DIR, 'train_preprocessing_2.csv')
TEST_PROCESSED_FILE = os.path.join(PREPROCESSING_DIR, 'test_preprocessing_2.csv')
ORIGINAL_TRAIN_FILE = os.path.join(DATA_DIR, 'train.csv')

def run_model():
    print("--- Loading Data (Preprocessing 2) ---")
    try:
        train_df = pd.read_csv(TRAIN_PROCESSED_FILE)
        test_df = pd.read_csv(TEST_PROCESSED_FILE)
        original_train = pd.read_csv(ORIGINAL_TRAIN_FILE)
    except FileNotFoundError as e:
        print(f"Error loading files: {e}")
        print("Please ensure 'preprocessing/preprocessing_2.py' has been run.")
        sys.exit(1)

    # --- 2. Prepare Data ---
    target_col = 'personality_cluster'
    id_col = 'participant_id'

    # Train data
    X_train = train_df.drop(columns=[target_col])
    y_train = train_df[target_col]

    # Test data
    X_test = test_df.drop(columns=[id_col])
    test_ids = test_df[id_col]

    print(f"Training data shape: {X_train.shape}")
    print(f"Test data shape: {X_test.shape}")

    # --- 3. Feature Scaling (Required for MultinomialNB) ---
    # MultinomialNB fails with negative values.
    # preprocessing_2.py used RobustScaler, which centers data and creates negatives.
    # We must scale features to [0, 1] range.
    print("\nScaling features to [0, 1] range for Naive Bayes...")
    scaler = MinMaxScaler()
    X_train_scaled = scaler.fit_transform(X_train)
    X_test_scaled = scaler.transform(X_test)

    # --- 4. Hyperparameter Tuning (GridSearchCV) ---
    print("\nStarting Grid Search for MultinomialNB...")
    
    mnb = MultinomialNB()

    # Tune 'alpha' (smoothing parameter) and 'fit_prior'
    param_grid = {
        'alpha': [0.01, 0.1, 0.5, 1.0, 2.0, 5.0, 10.0],
        'fit_prior': [True, False]
    }

    grid_search = GridSearchCV(
        estimator=mnb,
        param_grid=param_grid,
        cv=5,
        scoring='f1_macro', # Optimize for competition metric
        n_jobs=-1,
        verbose=1
    )

    grid_search.fit(X_train_scaled, y_train)

    print(f"\nBest Parameters found: {grid_search.best_params_}")
    print(f"Best CV F1 Macro Score: {grid_search.best_score_:.4f}")

    best_model = grid_search.best_estimator_

    # --- 5. Make Predictions ---
    print("\nMaking predictions on test set...")
    y_pred_encoded = best_model.predict(X_test_scaled)

    # --- 6. Inverse Transform Predictions ---
    le = LabelEncoder()
    le.fit(original_train[target_col])
    y_pred_labels = le.inverse_transform(y_pred_encoded)

    # --- 7. Create Submission File ---
    submission_df = pd.DataFrame({
        id_col: test_ids,
        target_col: y_pred_labels
    })

    submission_file = os.path.join(OUTPUT_DIR, 'multinomial_naive_bayes_2.csv')
    submission_df.to_csv(submission_file, index=False)

    print(f"\nSubmission file generated: {submission_file}")
    print(submission_df.head())

if __name__ == "__main__":
    run_model()